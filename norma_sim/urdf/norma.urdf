<?xml version="1.0"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro" name="norma">

  <material name="blue">
    <color rgba="0 0 0.8 1"/>
  </material>

  <material name="gray">
    <color rgba="0.8 0.8 0.8 1"/>
  </material>

  <xacro:macro name="caster" params="name reflect_x reflect_y">
    <collision name="${name}_caster_collision">
      <origin rpy=" 0 0 0" xyz="${reflect_x*(base_size_x/2-caster_radius)} ${reflect_y*(base_size_y/2-caster_radius)} ${-base_size_z/2-caster_radius}"/>
        <geometry>
          <sphere radius="${caster_radius}"/>
        </geometry>
      <surface>
        <friction>
          <ode>
            <mu>0</mu>
            <mu2>0</mu2>
            <slip1>1.0</slip1>
            <slip2>1.0</slip2>
          </ode>
        </friction>
      </surface>
    </collision>

    <visual name="${name}_caster_visual">
      <origin rpy=" 0 0 0" xyz="${reflect_x*(base_size_x/2-caster_radius)} ${reflect_y*(base_size_y/2-caster_radius)} ${-base_size_z/2-caster_radius}"/>
      <geometry>
        <sphere radius="${caster_radius}"/>
      </geometry>
    </visual>
  </xacro:macro>

  <xacro:property name="base_mass" value="2" />
  <xacro:property name="base_size_y" value="0.45" />
  <xacro:property name="base_size_x" value="0.8" />
  <xacro:property name="base_size_z" value="0.5" />
  <xacro:property name="base_size" value="${base_size_x} ${base_size_y} ${base_size_z}" />
  <xacro:property name="caster_radius" value="0.05" />
  <link name="base_link">
    <visual>
      <geometry>
        <box size="${base_size}"/>
      </geometry>
      <material name="blue"/>
    </visual>

    <collision>
      <geometry>
        <box size="${base_size}"/>
      </geometry>
    </collision>

    <inertial>
      <mass value="${base_mass}"/>
      <inertia ixx="${1/12*base_mass*(base_size_z*base_size_z+base_size_y*base_size_y)}" ixy="0.0" ixz="0.0" iyy="${1/12*base_mass*(base_size_x*base_size_x+base_size_z*base_size_z)}" iyz="0.0" izz="${1/12*base_mass*(base_size_x*base_size_x+base_size_y*base_size_y)}"/>
    </inertial>
    


    <xacro:caster name="rr" reflect_x="-1" reflect_y="-1"/>
    <xacro:caster name="fr" reflect_x="1" reflect_y="-1"/>
    <xacro:caster name="fl" reflect_x="1" reflect_y="1"/>
    <xacro:caster name="rl" reflect_x="-1" reflect_y="1"/>
  </link>

  <xacro:property name="wheel_radious" value="0.1" />
  <xacro:property name="wheel_length" value="0.1" />
  <xacro:property name="wheel_mass" value="0.1" />
  <xacro:macro name="wheel" params="wheel_name reflect">
    <link name="${wheel_name}_wheel">
      <visual>
        <geometry>
          <cylinder length="${wheel_length}" radius="${wheel_radious}"/>
        </geometry>
        <origin rpy="1.57075 0 0"/>
        <material name="gray"/>
      </visual>

      <collision>
        <geometry>
          <cylinder length="${wheel_length}" radius="${wheel_radious}"/>
        </geometry>
        <origin rpy="1.57075 0 0"/>
      </collision>

      <inertial>
        <mass value="${wheel_mass}"/>
        <inertia ixx="${1/12*wheel_mass*(3*wheel_radious*wheel_radious+wheel_length*wheel_length)}" ixy="0.0" ixz="0.0" iyy="${1/12*wheel_mass*(3*wheel_radious*wheel_radious+wheel_length*wheel_length)}" iyz="0.0" izz="${1/2*wheel_mass*wheel_radious*wheel_radious}"/>
      </inertial>
    </link>

    <joint name="base_to_${wheel_name}_wheel" type="continuous">
      <parent link="base_link"/>
      <child link="${wheel_name}_wheel"/>
      <origin xyz="0 ${reflect*(base_size_y+wheel_length)/2} ${-base_size_z/2}"/>
      <axis xyz="0 1 0"/>
      <limit effort="10000" velocity="1000"/>
      <joint_properties damping="1.0" friction="1.0" />
    </joint>
    <transmission name="${wheel_name}_wheel_trans">
      <type>transmission_interface/SimpleTransmission</type>
      <actuator name="${wheel_name}_wheel_motor">
        <mechanicalReduction>1</mechanicalReduction>
        <hardwareInterface>
          VelocityJointInterface
        </hardwareInterface>
      </actuator>
      <joint name="base_to_${wheel_name}_wheel">
        <hardwareInterface>hardware_interface/VelocityJointInterface</hardwareInterface>
      </joint>
    </transmission>
  </xacro:macro>

  <xacro:wheel wheel_name="left" reflect="-1"/>
  <xacro:wheel wheel_name="right" reflect="1"/>

  <xacro:property name="lidar_radious" value="0.05" />
  <xacro:property name="lidar_length" value="0.1" />
  <xacro:macro name="laser_sensor" params="parent name translation orientation">
    <link name="laser_${name}">
      <collision>
        <origin xyz="${lidar_radious} 0 0" rpy="0 0 0"/>
        <geometry>
          <cylinder radius="${lidar_radious}" length="${lidar_length}"/>
        </geometry>
      </collision>
      <visual>
        <origin xyz="${lidar_radious} 0 0" rpy="0 0 0"/>
        <geometry>
          <cylinder radius="${lidar_radious}" length="${lidar_length}"/>
        </geometry>
      </visual>
      <inertial>
        <mass value="1e-5" />
        <inertia ixx="1e-6" ixy="0" ixz="0" iyy="1e-6" iyz="0" izz="1e-6" />
      </inertial>
    </link>
    <joint name="laser_${name}_joint" type="fixed">
      <axis xyz="0 0 1" />
      <origin xyz="${translation}" rpy="${orientation}"/>
      <parent link="${parent}"/>
      <child link="laser_${name}"/>
    </joint>
  </xacro:macro>

  <gazebo reference="laser">
    <sensor type="ray" name="head_hokuyo_sensor">
      <pose>0 0 0 0 0 0</pose>
      <visualize>false</visualize>
      <update_rate>20</update_rate>
      <ray>
        <scan>
          <horizontal>
            <samples>720</samples>
            <resolution>1</resolution>
            <min_angle>-1.570796</min_angle>
            <max_angle>1.570796</max_angle>
          </horizontal>
        </scan>
        <range>
          <min>0.10</min>
          <max>10.0</max>
          <resolution>0.01</resolution>
        </range>
        <noise>
          <type>gaussian</type>
          <mean>0.0</mean>
          <stddev>0.01</stddev>
        </noise>
      </ray>
      <plugin name="gazebo_ros_head_hokuyo_controller" filename="libgazebo_ros_laser.so">
        <topicName>/scan</topicName>
        <frameName>laser_rear</frameName>
      </plugin>
    </sensor>
  </gazebo>

  <xacro:laser_sensor parent="base_link" name="rear" translation="-0.450 0 0" orientation="0 0 3.14159265359"/>

  <gazebo>
    <plugin name="gazebo_ros_control" filename="libgazebo_ros_control.so">
      <robotNamespace>/</robotNamespace>
    </plugin>
  </gazebo>
</robot>

